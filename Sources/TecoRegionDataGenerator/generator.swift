import ArgumentParser
import Foundation
import SwiftSyntax
import SwiftSyntaxBuilder
@_implementationOnly import TecoCore
import TecoCodeGeneratorCommons

@main
struct TecoRegionDataGenerator: AsyncParsableCommand {
    @Option(name: .shortAndLong, completion: .file(extensions: ["swift"]), transform: URL.init(fileURLWithPath:))
    var output: URL

    func run() async throws {
        let client = Region()
        defer { try? client.shutdown() }

        let map = getRegionMap(from: try await client.describeRegions(for: "vpc"))
        let intlMap = getRegionMap(from: try await client.with(language: .en_US).describeRegions(for: "vpc"))

        let sourceFile = SourceFileSyntax {
            ImportDeclSyntax("""
                // THIS FILE IS AUTOMATICALLY GENERATED by TecoRegionDataGenerator.
                // DO NOT EDIT.
                
                @_implementationOnly import OrderedCollections
                """)

            StructDeclSyntax("""
                struct Region: Hashable {
                    let id: String
                    let localizedNames: OrderedSet<String>
                    init(id: String, localizedNames: String...) {
                        self.id = id
                        self.localizedNames = OrderedSet(localizedNames)
                    }
                }
                """)

            VariableDeclSyntax("let regions: [Region] = \(buildRegionListExpr(from: intlMap, map))")

        }

        try sourceFile.save(to: self.output)
    }
}
